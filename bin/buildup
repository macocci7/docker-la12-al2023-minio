#!/bin/bash

#--------------------------------------------------------#
# Script to build up entire environment for development.
# - Creates a new Laravel 12 project
# - Copies .env.local to .env
# - Layouts Laravel files for environment testing.
# - Creates TLS certs for MinIO
# - Builds containers
# - Runs initial settings
#     - Performs database migration (MySQL)
#     - Sets permissions
#     - Enables and boots services
# - Runs environment tests
#     - Laravel test (php artisan test)
#     - SMTP test (php artisan mail:send)
#     - Queue test (php artisan mail:queue)
#     - Storage upload test (php artisan minio:put)
#     - Storage download test (php artisan minio:get)
#--------------------------------------------------------#

SCRIPT_DIR=$(cd $(dirname $0) && pwd)

# - Check commands
check_command () {
    COMMAND="$*"
    $COMMAND
    if [ $? -ne 0 ]; then
        printf '\033[37;41m%s\033[m\n' "Failed to run: [${COMMAND}]"
        printf '\033[37;41m%s\033[m\n' "Operation aborted."
        exit 1
    fi
}

print_red_back () {
    printf '\033[37;41m%s\033[m\n' "${1}"
}

# Confirmation
echo
echo "This script performs building up new containers with docker-compose.yml"
CAN_CONTINUE=""
while [[ ! $CAN_CONTINUE =~ ^[ny]$ ]]; do
    echo -n "Are you sure to continue? [y/n]:"
    read CAN_CONTINUE
done
if [ $CAN_CONTINUE = "n" ]; then
    print_red_back "Operation aborted."
    exit 1
fi

# Command test
check_command composer --version
check_command mkcert --version
check_command docker --version

# Cleans up MySQL data
DATA_DIR=$(cd ${SCRIPT_DIR}/../docker/mysql/data && pwd)
ENTRIES=`ls -a -I '.' -I '..' -I '.gitignore' ${DATA_DIR}`
if [ -n "${ENTRIES}" ]; then
    check_command sudo ${SCRIPT_DIR}/mysql-cleanup
fi

# Cleans up MinIO data
check_command ${SCRIPT_DIR}/minio-cleanup

# - Creates a new Laravel 12 project
check_command ${SCRIPT_DIR}/create-laravel-project

# - Copies .env.local to .env
check_command cp -f laravel/.env.local html/.env.local
check_command cp -f laravel/.env.local html/.env

# - Layouts Laravel files for environment testing.
check_command cp -rf laravel/* html/

# - Creates TLS certs for MinIO
check_command mkcert -install
check_command mkcert -cert-file ./docker/minio/certs/public.crt -key-file ./docker/minio/certs/private.key localhost

# - Builds containers
check_command docker compose up -d

# - Runs initial settings
#     - Sets permissions
#     - Performs database migration (MySQL)
#     - Enables and boots services
check_command bin/change-permissions
check_command bin/artisan key:generate
echo "Waiting for 10 seconds..."
sleep 10
check_command bin/artisan migrate
check_command bin/initial-settings

# - Runs environment tests
#     - Laravel test (php artisan test)
#     - SMTP test (php artisan mail:send)
#     - Queue test (php artisan mail:queue)
#     - Storage upload test (php artisan minio:put)
#     - Storage download test (php artisan minio:get)
check_command bin/artisan test
check_command bin/artisan mail:send
check_command bin/artisan mail:queue
check_command bin/artisan minio:put
check_command bin/artisan minio:get
